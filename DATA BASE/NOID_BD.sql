-- Crear base de datos
CREATE DATABASE IF NOT EXISTS NOID_BD;
USE NOID_BD;

-- Crear tabla USUARIO
CREATE TABLE USUARIO (
    ID_USUARIO INT AUTO_INCREMENT PRIMARY KEY,
    NOMBRE_USUARIO VARCHAR(100) NOT NULL,
    CONTRASENA VARCHAR(255) NOT NULL,
    TIPO ENUM('ADMINISTRADOR', 'COMPRADOR') NOT NULL
);

-- Crear tabla CATEGORIA
CREATE TABLE CATEGORIA (
    ID_CATEGORIA VARCHAR(10) PRIMARY KEY,
    NOMBRE_CATEGORIA VARCHAR(50) NOT NULL
);


INSERT INTO CATEGORIA (ID_CATEGORIA, NOMBRE_CATEGORIA) VALUES
('PC', 'Computadoras'),
('LAP', 'Laptops'),
('MON', 'Monitores'),
('MOU', 'Mouse'),
('KEY', 'Teclados'),
('SPE', 'Altavoces'),
('CAS', 'Cajas'),
('COM', 'Componentes');


CREATE TABLE PRODUCTOS (
    ID_PRODUCTO VARCHAR(10) PRIMARY KEY,
    ID_CATEGORIA VARCHAR(10) NOT NULL,
    NOMBRE_PRODUCTO VARCHAR(150) NOT NULL,
    MODELO VARCHAR(100) NOT NULL,
    PRECIO_UNITARIO DECIMAL(10,2) NOT NULL,
    FECHA_DE_CAPTURA DATE NOT NULL,
    CANTIDAD INT NOT NULL,
    ESTADO ENUM('DISPONIBLE', 'CASI AGOTADO', 'AGOTADO') NOT NULL,
    DESCRIPCION TEXT,
    IMAGEN VARCHAR(255),
    NUMERO_DE_SERIE VARCHAR(100) UNIQUE NOT NULL,
    FOREIGN KEY (ID_CATEGORIA) REFERENCES CATEGORIA(ID_CATEGORIA)
);


CREATE TABLE SECUENCIA_PRODUCTO (
    ID_CATEGORIA VARCHAR(10) PRIMARY KEY,
    ULTIMO_NUMERO INT NOT NULL DEFAULT 0
);

INSERT INTO SECUENCIA_PRODUCTO (ID_CATEGORIA) VALUES
('PC'), ('LAP'), ('MON'), ('MOU'), ('KEY'), ('SPE'), ('CAS'), ('COM');


-- Crear tabla CARRITO
CREATE TABLE CARRITO (
    ID_CARRITO INT AUTO_INCREMENT PRIMARY KEY,
    ID_USUARIO INT NOT NULL,
    ID_PRODUCTO VARCHAR(10) NOT NULL,
    CANTIDAD INT NOT NULL,
    TOTAL_PRECIO DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO(ID_USUARIO) ON DELETE CASCADE,
    FOREIGN KEY (ID_PRODUCTO) REFERENCES PRODUCTOS(ID_PRODUCTO) ON DELETE CASCADE
);

-- Crear tabla VISA
CREATE TABLE VISA (
    NUMERO_VISA VARCHAR(16) PRIMARY KEY,
    FECHA_VENCIMIENTO DATE NOT NULL,
    VCC VARCHAR(4) NOT NULL,
    MONTO DECIMAL(10,2) NOT NULL CHECK (MONTO <= 1000),
    ID_USUARIO INT NOT NULL,
    FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO(ID_USUARIO) ON DELETE CASCADE
);

-- Crear tabla RECIBO
CREATE TABLE RECIBO (
    ID_RECIBO INT AUTO_INCREMENT PRIMARY KEY,
    ID_USUARIO INT NOT NULL,
    ID_CARRITO INT NOT NULL,
    TOTAL_PRECIO DECIMAL(10,2) NOT NULL,
    FECHA_RECIBO DATE NOT NULL,
    NUMERO_VISA VARCHAR(16) NOT NULL,
    FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO(ID_USUARIO) ON DELETE CASCADE,
    FOREIGN KEY (ID_CARRITO) REFERENCES CARRITO(ID_CARRITO) ON DELETE CASCADE,
    FOREIGN KEY (NUMERO_VISA) REFERENCES VISA(NUMERO_VISA) ON DELETE CASCADE
);

-- Crear tabla COMPRA
CREATE TABLE COMPRA (
    ID_COMPRA INT AUTO_INCREMENT PRIMARY KEY,
    ID_USUARIO INT NOT NULL,
    FECHA_COMPRA DATETIME DEFAULT CURRENT_TIMESTAMP,
    TOTAL_COMPRA DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO(ID_USUARIO) ON DELETE CASCADE
);

DELIMITER $$

CREATE TRIGGER generar_id_producto
BEFORE INSERT ON PRODUCTOS
FOR EACH ROW
BEGIN
    DECLARE nuevo_numero INT;
    DECLARE nuevo_id VARCHAR(10);

    -- Obtener y aumentar el último número de la categoría
    SELECT ULTIMO_NUMERO + 1 INTO nuevo_numero
    FROM SECUENCIA_PRODUCTO
    WHERE ID_CATEGORIA = NEW.ID_CATEGORIA;

    -- Actualizar el número en la tabla de secuencia
    UPDATE SECUENCIA_PRODUCTO
    SET ULTIMO_NUMERO = nuevo_numero
    WHERE ID_CATEGORIA = NEW.ID_CATEGORIA;

    -- Formar el ID final (ej. PC-01, LAP-03)
    SET nuevo_id = CONCAT(NEW.ID_CATEGORIA, '-', LPAD(nuevo_numero, 2, '0'));

    -- Asignarlo al nuevo producto
    SET NEW.ID_PRODUCTO = nuevo_id;
END$$

DELIMITER ;


-- INSERTAR USUARIOS
INSERT INTO USUARIO (NOMBRE_USUARIO, CONTRASENA, TIPO) VALUES
('Josue', 'admin123', 'ADMINISTRADOR'),
('Edwin', 'clave456', 'ADMINISTRADOR'),
('Maria', 'pass789', 'ADMINISTRADOR'),
('Mario', 'admin987', 'ADMINISTRADOR'),
('Ana', 'comprador1', 'COMPRADOR'),
('Luis', 'comprador2', 'COMPRADOR'),
('Carolina', 'comprador3', 'COMPRADOR'),
('Pedro', 'comprador4', 'COMPRADOR');

-- INSERTAR PRODUCTOS (con trigger generador de ID_PRODUCTO)
INSERT INTO PRODUCTOS (
    ID_CATEGORIA, NOMBRE_PRODUCTO, MODELO, PRECIO_UNITARIO, FECHA_DE_CAPTURA,
    CANTIDAD, ESTADO, DESCRIPCION, IMAGEN, NUMERO_DE_SERIE
) VALUES
('PC', 'Computadora Gamer', 'GTX-FX900', 1200.00, '2025-04-09', 10, 'DISPONIBLE', 'Equipo de alto rendimiento para gaming.', 'pc1.jpg', 'SN-PC-001'),
('LAP', 'Laptop Lenovo ThinkPad', 'LTP-X100', 899.99, '2025-04-08', 5, 'CASI AGOTADO', 'Laptop ideal para trabajo y estudio.', 'lap1.jpg', 'SN-LAP-001'),
('MON', 'Monitor Samsung 27"', 'MON-S27', 250.50, '2025-04-07', 2, 'AGOTADO', 'Pantalla Full HD curva.', 'mon1.jpg', 'SN-MON-001'),
('MOU', 'Mouse Logitech Inalámbrico', 'MOU-G305', 35.00, '2025-04-09', 25, 'DISPONIBLE', 'Mouse ligero y ergonómico.', 'mou1.jpg', 'SN-MOU-001'),
('KEY', 'Teclado Mecánico Redragon', 'KEY-K552', 45.99, '2025-04-08', 12, 'DISPONIBLE', 'Switches rojos, iluminación RGB.', 'key1.jpg', 'SN-KEY-001');


-- Inserciones a la tabla VISA
INSERT INTO VISA (NUMERO_VISA, FECHA_VENCIMIENTO, VCC, MONTO, ID_USUARIO) VALUES
('4111111111111111', '2027-10-01', '123', 1000.00, 5), -- Ana
('4222222222222222', '2026-07-15', '456', 800.00, 6), -- Luis
('4333333333333333', '2028-03-20', '789', 950.50, 7),-- Carolina
('4444444444444444', '2029-01-10', '321', 999.99, 8); -- Pedro

-- INSERTAR CARRITOS
INSERT INTO CARRITO (ID_USUARIO, ID_PRODUCTO, CANTIDAD, TOTAL_PRECIO) VALUES
(5, 'PC-01', 1, 1200.00),
(6, 'LAP-01', 1, 899.99),
(7, 'MOU-01', 2, 70.00),
(8, 'KEY-01', 1, 45.99);

-- INSERTAR COMPRAS
INSERT INTO COMPRA (ID_USUARIO, TOTAL_COMPRA) VALUES
(5, 1200.00),
(6, 899.99),
(7, 70.00),
(8, 45.99);

-- INSERTAR RECIBOS
INSERT INTO RECIBO (ID_USUARIO, ID_CARRITO, TOTAL_PRECIO, FECHA_RECIBO, NUMERO_VISA) VALUES
(5, 1, 1200.00, '2025-04-09', '4111111111111111'),
(6, 2, 899.99, '2025-04-09', '4222222222222222'),
(7, 3, 70.00, '2025-04-09', '4333333333333333'),
(8, 4, 45.99, '2025-04-09', '4444444444444444');


